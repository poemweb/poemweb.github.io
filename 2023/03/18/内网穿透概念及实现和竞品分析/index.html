<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><title>内网穿透原理和竞品分析 | Poem blog</title><meta name="author" content="渊鱼"><meta name="copyright" content="渊鱼"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="概述：本文档旨在让阅读者了解，什么是内网穿透，内网穿透的实现方案和这些方案对应的竞品情况。 1、什么是内网穿透1.1 内网&#x2F;外网定义内网：内网其实就是在公司或者是家庭内部建立的一种局域网络或者办公网络，可以实现多台电脑之间进行资源共享，包括设备、资料、数据等； 外网：外网是由一个网关与其它的网络系统连接，相对于内网而言，这种网络系统称之为外部网络，也就是我们经常说到的互联网。 1.2 内">
<meta property="og:type" content="article">
<meta property="og:title" content="内网穿透原理和竞品分析">
<meta property="og:url" content="http://example.com/2023/03/18/%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F%E6%A6%82%E5%BF%B5%E5%8F%8A%E5%AE%9E%E7%8E%B0%E5%92%8C%E7%AB%9E%E5%93%81%E5%88%86%E6%9E%90/index.html">
<meta property="og:site_name" content="Poem blog">
<meta property="og:description" content="概述：本文档旨在让阅读者了解，什么是内网穿透，内网穿透的实现方案和这些方案对应的竞品情况。 1、什么是内网穿透1.1 内网&#x2F;外网定义内网：内网其实就是在公司或者是家庭内部建立的一种局域网络或者办公网络，可以实现多台电脑之间进行资源共享，包括设备、资料、数据等； 外网：外网是由一个网关与其它的网络系统连接，相对于内网而言，这种网络系统称之为外部网络，也就是我们经常说到的互联网。 1.2 内">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/image/3.jpg">
<meta property="article:published_time" content="2023-03-18T07:31:50.033Z">
<meta property="article:modified_time" content="2023-03-18T07:37:10.806Z">
<meta property="article:author" content="渊鱼">
<meta property="article:tag" content="网络">
<meta property="article:tag" content="技术">
<meta property="article:tag" content="内网穿透">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/image/3.jpg"><link rel="shortcut icon" href="/image/4.png"><link rel="canonical" href="http://example.com/2023/03/18/%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F%E6%A6%82%E5%BF%B5%E5%8F%8A%E5%AE%9E%E7%8E%B0%E5%92%8C%E7%AB%9E%E5%93%81%E5%88%86%E6%9E%90/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '内网穿透原理和竞品分析',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-03-18 15:37:10'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/back.css"><meta name="generator" content="Hexo 6.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/image/3.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">4</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">5</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 产品内容</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 技术知识</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 设计知识</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 人文社科</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 杂谈</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background: url(/image/2.jpg)"><nav id="nav"><span id="blog-info"><a href="/" title="Poem blog"><span class="site-name">Poem blog</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 产品内容</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 技术知识</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 设计知识</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 人文社科</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 杂谈</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">内网穿透原理和竞品分析</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-03-18T07:31:50.033Z" title="发表于 2023-03-18 15:31:50">2023-03-18</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-03-18T07:37:10.806Z" title="更新于 2023-03-18 15:37:10">2023-03-18</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="内网穿透原理和竞品分析"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>概述：本文档旨在让阅读者了解，什么是内网穿透，内网穿透的实现方案和这些方案对应的竞品情况。</p>
<h1 id="1、什么是内网穿透"><a href="#1、什么是内网穿透" class="headerlink" title="1、什么是内网穿透"></a>1、什么是内网穿透</h1><h2 id="1-1-内网-x2F-外网定义"><a href="#1-1-内网-x2F-外网定义" class="headerlink" title="1.1 内网&#x2F;外网定义"></a>1.1 内网&#x2F;外网定义</h2><p>内网：内网其实就是在公司或者是家庭内部建立的一种局域网络或者办公网络，可以实现多台电脑之间进行资源共享，包括设备、资料、数据等；</p>
<p>外网：外网是由一个网关与其它的网络系统连接，相对于内网而言，这种网络系统称之为外部网络，也就是我们经常说到的互联网。</p>
<h2 id="1-2-内网穿透概述"><a href="#1-2-内网穿透概述" class="headerlink" title="1.2 内网穿透概述"></a>1.2 内网穿透概述</h2><p>内网穿透是我们在进行网络连接时的一种术语，也叫做NAT穿透，就是在计算机是局域网内的时候，外网与内网的计算机的节点进行连接时所需要的连接通信。</p>
<p>一般而言，在没有固定公网IP的情况下，外网设备无法直接访问内网设备。而内网穿透技术，顾名思义就是能让外网的设备找到处于内网的设备，从而实现数据通信。</p>
<h2 id="1-3-NAT的实现方式"><a href="#1-3-NAT的实现方式" class="headerlink" title="1.3 NAT的实现方式"></a>1.3 NAT的实现方式</h2><p>NAT的实现方式有三种，即静态转换Static Nat、动态转换Dynamic Nat和端口多路复用OverLoad。</p>
<p><strong>静态转换</strong>是指将内部网络的私有IP地址转换为公有IP地址，IP地址对是一对一的，是一成不变的，某个私有IP地址只转换为某个公有IP地址。借助于静态转换，可以实现外部网络对内部网络中某些特定设备（如服务器）的访问。</p>
<p><strong>动态转换</strong>是指将内部网络的私有IP地址转换为公用IP地址时，IP地址是不确定的，是随机的，所有被授权访问上Internet的私有IP地址可随机转换为任何指定的合法IP地址。也就是说，只要指定哪些内部地址可以进行转换，以及用哪些合法地址作为外部地址时，就可以进行动态转换。动态转换可以使用多个合法外部地址集。当ISP提供的合法IP地址略少于网络内部的计算机数量时。可以采用动态转换的方式。</p>
<p><strong>端口多路复用（Port address Translation,PAT）</strong>是指改变外出数据包的源端口并进行端口转换，即端口地址转换（PAT，Port Address Translation）.采用端口多路复用方式。内部网络的所有主机均可共享一个合法外部IP地址实现对Internet的访问，从而可以最大限度地节约IP地址资源。同时，又可隐藏网络内部的所有主机，有效避免来自internet的攻击。因此，网络中应用最多的就是端口多路复用方式。</p>
<h2 id="1-4-NAT穿透原理"><a href="#1-4-NAT穿透原理" class="headerlink" title="1.4 NAT穿透原理"></a>1.4 NAT穿透原理</h2><p>内网穿透，又称为NAT穿透。NAT背后的设备，它们的主要特点是 ，可以访问外网，但不能被外网设备有效访问。</p>
<p>基于这一特点，NAT穿透技术是让NAT背后的设备，先访问指定的外网服务器，由指定的外网服务器搭建桥梁，打通内、外网设备的访问通道，实现外网设备访问到内网设备。</p>
<h2 id="1-5-访问内网的方法"><a href="#1-5-访问内网的方法" class="headerlink" title="1.5 访问内网的方法"></a>1.5 访问内网的方法</h2><h3 id="1-5-1-ddns动态域名绑定-端口转发（能访问内网，不算内网穿透）"><a href="#1-5-1-ddns动态域名绑定-端口转发（能访问内网，不算内网穿透）" class="headerlink" title="1.5.1 ddns动态域名绑定+端口转发（能访问内网，不算内网穿透）"></a>1.5.1 ddns动态域名绑定+端口转发（能访问内网，不算内网穿透）</h3><p>需要满足以下条件：</p>
<p>1、公网IP</p>
<p>2、路由器支持<a target="_blank" rel="noopener" href="https://www.zhihu.com/search?q=ddns&search_source=Entity&hybrid_search_source=Entity&hybrid_search_extra=%7B%22sourceType%22:%22answer%22,%22sourceId%22:2445680036%7D">ddns</a>动态域名绑定</p>
<p>3、路由器支持端口转发</p>
<p>优点：不受第三方服务器速度限制</p>
<p>缺点：需要域名、公网IP以及支持DDNS</p>
<h3 id="1-5-2-端口映射"><a href="#1-5-2-端口映射" class="headerlink" title="1.5.2 端口映射"></a>1.5.2 端口映射</h3><p>端口映射发生于节点与路由&#x2F;网关之间，以NAT（Network Address Translation，网络地址翻译）为原理；而端口转发以反向隧道、反向代理为原理，发生于两个网络节点的端口之间。</p>
<p>需要满足以下条件：</p>
<p>1、一台有公网ip的服务器</p>
<p>2、需要穿透的电脑安装客户端软件</p>
<p>优点：简单快捷</p>
<p>缺点：受限于第三方服务器网速（加钱可提高）</p>
<h3 id="1-5-3-异地组网"><a href="#1-5-3-异地组网" class="headerlink" title="1.5.3 异地组网"></a>1.5.3 异地组网</h3><p>虚拟出一块网卡，连上一个虚拟网络，安装了客户端的设备可以连入这个网络，经过授权连接成功之后彼此都在同一网段，可以像在局域网一样互相访问，例如访问共享文件夹，web server，ftp server，联机游戏（例如打星际），当然也就包括访问NAS。所以如果你的NAS和你的手机连上了这个网络，不论两台设备具体在哪里，都像同一局域网内，从而实现内网穿透，达到从外网访问内网群晖的目的。</p>
<p>需要满足以下条件：</p>
<p>1、需要在客户端安装客户端软件并加入虚拟网络</p>
<p>优点：简单快捷，无需第三方服务器</p>
<p>缺点：虚拟网络十分不稳定，内网穿透依赖的打洞技术限制较多</p>
<h3 id="1-5-4-总结"><a href="#1-5-4-总结" class="headerlink" title="1.5.4 总结"></a>1.5.4 总结</h3><p>目前需要实现内网穿透，从底层技术实现上分为端口映射类和异地组网类，下面结合竞品对这两种内网穿透技术进行详细分析。</p>
<h1 id="2、竞品分析"><a href="#2、竞品分析" class="headerlink" title="2、竞品分析"></a>2、竞品分析</h1><h2 id="2-1-端口映射"><a href="#2-1-端口映射" class="headerlink" title="2.1 端口映射"></a>2.1 端口映射</h2><p>端口映射是目前市面上较为成熟，且大多数竞品采用的解决方案，以下讨论的端口映射前提都是基于用户客户端设备所处局域网没有其可用的外网IP地址情况下，端口映射的实现方式。</p>
<p>代表竞品：花生壳，Frp（开源解决方案）</p>
<h3 id="2-1-1-Frp（开源解决方案）"><a href="#2-1-1-Frp（开源解决方案）" class="headerlink" title="2.1.1 Frp（开源解决方案）"></a>2.1.1 Frp（开源解决方案）</h3><h4 id="2-1-1-1-概述"><a href="#2-1-1-1-概述" class="headerlink" title="2.1.1.1 概述"></a>2.1.1.1 概述</h4><p>frp 是一个专注于内网穿透的高性能的反向代理应用，支持 TCP、UDP、HTTP、HTTPS 等多种协议。可以将内网服务以安全、便捷的方式通过具有公网 IP 节点的中转暴露到公网。 <a target="_blank" rel="noopener" href="https://github.com/fatedier/frp">frp 项目官网</a> <a target="_blank" rel="noopener" href="https://github.com/fatedier/frp/blob/dev/README_zh.md">中文文档</a> <a target="_blank" rel="noopener" href="https://github.com/fatedier/frp/releases">客户端和服务端</a></p>
<h4 id="2-1-1-2-Frp特点与原理"><a href="#2-1-1-2-Frp特点与原理" class="headerlink" title="2.1.1.2 Frp特点与原理"></a>2.1.1.2 Frp特点与原理</h4><p><strong>Frp特点：</strong></p>
<p>通过在具有公网 IP 的节点上部署 frp 服务端，可以轻松地将内网服务穿透到公网，同时提供诸多专业的功能特性，这包括：</p>
<ul>
<li><p>客户端服务端通信支持 TCP、KCP 以及 Websocket 等多种协议。</p>
</li>
<li><p>采用 TCP 连接流式复用，在单个连接间承载更多请求，节省连接建立时间。</p>
</li>
<li><p>代理组间的负载均衡。</p>
</li>
<li><p>端口复用，多个服务通过同一个服务端端口暴露。</p>
</li>
<li><p>多个原生支持的客户端插件（静态文件查看，HTTP、SOCK5 代理等），便于独立使用 frp 客户端完成某些工作。</p>
</li>
<li><p>高度扩展性的服务端插件系统，方便结合自身需求进行功能扩展。</p>
</li>
<li><p>服务端和客户端 UI 页面。</p>
</li>
</ul>
<p><strong>工作原理：</strong></p>
<p>服务端运行，监听一个主端口，等待客户端的连接；</p>
<p>客户端连接到服务端的主端口，同时告诉服务端要监听的端口和转发类型；</p>
<p>服务端fork新的进程监听客户端指定的端口；</p>
<p>外网用户连接到客户端指定的端口，服务端通过和客户端的连接将数据转发到客户端；</p>
<p>客户端进程再将数据转发到本地服务，从而实现内网对外暴露服务的能力。</p>
<h4 id="2-1-1-3-Frp的使用流程"><a href="#2-1-1-3-Frp的使用流程" class="headerlink" title="2.1.1.3 Frp的使用流程"></a>2.1.1.3 Frp的使用流程</h4><p>frp实际使用时，会按照端口号进行对应的转发，原理如下图所示。</p>
<p><img src="/image/4-1.png" alt="avatar"></p>
<hr>
<p>以下这个示例通过简单配置 TCP 类型的代理让用户访问到内网的服务器。</p>
<p>1、在具有公网 IP 的机器上部署 frps，修改 frps.ini 文件，这里使用了最简化的配置，设置了 frp 服务器用户接收客户端连接的端口：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[common]</span><br><span class="line">bind_port = 7000</span><br></pre></td></tr></table></figure>

<p>2、在需要被访问的内网机器上（SSH 服务通常监听在 22 端口）部署 frpc，修改 frpc.ini 文件，假设 frps 所在服务器的公网 IP 为 x.x.x.x：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[common]server_addr = x.x.x.xserver_port = 7000[ssh]type = tcplocal_ip = 127.0.0.1local_port = 22remote_port = 6000</span><br></pre></td></tr></table></figure>

<p>其中<code>local_ip</code> 和 <code>local_port</code> 配置为本地需要暴露到公网的服务地址和端口。<code>remote_port</code> 表示在 frp 服务端监听的端口，访问此端口的流量将会被转发到本地服务对应的端口。</p>
<p>3、分别启动 frps 和 frpc。</p>
<p>4、通过 SSH 访问内网机器，假设用户名为 test：</p>
<p><code>ssh -oPort=6000 test@x.x.x.x</code></p>
<p>frp 会将请求 <code>x.x.x.x:6000</code> 的流量转发到内网机器的 22 端口。</p>
<h4 id="2-1-1-4-总结"><a href="#2-1-1-4-总结" class="headerlink" title="2.1.1.4 总结"></a>2.1.1.4 总结</h4><p>Frp的为开源的内网穿透解决方案，对于用户来说其具有以下特点</p>
<p>优点：</p>
<p>1.开源免费</p>
<p>2.配置较为简单（对于有一定内网穿透和linux基础的人而言）</p>
<p>3.教程较多，可以根据教程手把手配置</p>
<p>缺点：</p>
<p>1.需要自己准备一台带有外网 IP的服务器</p>
<p>2.穿透连接无法保证稳定</p>
<p>3.原理为端口映射，若映射的服务较多，则占用端口</p>
<p>用户分析：Frp适合C端用户有内网穿透需求，且有一定知识背景的用户。</p>
<h3 id="2-1-2-花生壳"><a href="#2-1-2-花生壳" class="headerlink" title="2.1.2 花生壳"></a>2.1.2 花生壳</h3><h4 id="2-1-2-1-概述"><a href="#2-1-2-1-概述" class="headerlink" title="2.1.2.1 概述"></a>2.1.2.1 概述</h4><p>花生壳为Oray公司旗下的内网穿透产品，其主打无需依赖公网IP、无需配置路由器，花生壳支持在客户端上添加端口映射，快速将内网服务发布到外网，支持通过手机APP实现远程的映射管理和设备管理，支持通过嵌入实现内网穿透。</p>
<p>支持系统：支持Windows&#x2F;macOS&#x2F;Linux&#x2F;树莓派&#x2F;嵌入式SDK等平台</p>
<h4 id="2-1-2-2-内网穿透操作流程"><a href="#2-1-2-2-内网穿透操作流程" class="headerlink" title="2.1.2.2 内网穿透操作流程"></a>2.1.2.2 内网穿透操作流程</h4><p>1.下载安装花生壳客户端软件</p>
<p>花生壳客户端支持多种操作系统，选择所需的操作系统下载并安装花生壳客户端软件。</p>
<p><img src="/image/4-2.png" alt="avatar"></p>
<p>2.登录</p>
<p>花生壳登录支持扫码登录（微信或花生壳APP扫码）和账号登录2种登录方式,均需绑定手机号。</p>
<p><img src="/image/4-3.png" alt="avatar"></p>
<p>3.登录并激活后，点击加号icon，进行内网穿透的配置。</p>
<p><img src="/image/4-4.png" alt="avatar"></p>
<p>4.配置表单如下</p>
<p><img src="/image/4-5.png" alt="avatar"></p>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td><strong>字段名称</strong></td>
<td><strong>说明</strong></td>
</tr>
<tr>
<td>*名称</td>
<td>该内网穿透名称</td>
</tr>
<tr>
<td>图标</td>
<td>该内网穿透的图标，存在默认图标</td>
</tr>
<tr>
<td>映射模板</td>
<td>有<code>不使用模板，Windows远程桌面，SSH服务，SQL Server服务</code>四种选项，选择模板后，将根据选择的模板类型对下面的字段进行自动填写，默认选择不使用模板</td>
</tr>
<tr>
<td>外网域名</td>
<td>外部访问的域名，从<code>域名管理</code>处获取，每个用户都会分配一个默认域名，可花钱进行自定义域名或增加域名</td>
</tr>
<tr>
<td>外网端口</td>
<td>有<code>动态端口，购买端口</code> 两种选择，即自定义端口需购买</td>
</tr>
<tr>
<td>内网主机</td>
<td>支持IPV4,IPV6格式的IP输入，可下拉选择127.0.0.1的localhost，也可点击右侧icon进行扫描<br><br><br><br><br></td>
</tr>
<tr>
<td>内网端口</td>
<td>选择要映射的内网端口</td>
</tr>
<tr>
<td>带宽</td>
<td>默认为1Mbps，需要增加则需付费购买</td>
</tr>
</tbody></table>
<p>5.填入表单后，点击保存建立连接，如下图，会对连接进行诊断，下图诊断为内网主机IP:端口不通</p>
<p><img src="/image/4-6.png" alt="avatar"></p>
<p>排查问题后发现127.0.0.1为无效地址，修改即可</p>
<p><img src="/image/4-7.png" alt="avatar"></p>
<p>修改后，成功！</p>
<p><img src="/image/4-8.png" alt="avatar"></p>
<h4 id="2-1-2-3-总结"><a href="#2-1-2-3-总结" class="headerlink" title="2.1.2.3 总结"></a>2.1.2.3 总结</h4><p>花生壳对于用户来说其具有以下特点</p>
<p>优点：</p>
<p>1.配置简单，只需配置客户端的前端信息（基本为表单填写）</p>
<p>2.使用方便，无需外网IP，无需域名</p>
<p>3.有丰富的操作手册和优秀的服务</p>
<p>缺点：</p>
<p>1.带宽限制（付费可解决）</p>
<p>2.功能基本为阉割版，其他功能需付费</p>
<p>用户分析：花生壳有企业版和个人版，能提供稳定的服务，适合所有有内网穿透需求且愿意为此付费的用户</p>
<p>总结：花生壳也是通过反向代理服务器做端口映射，不过其将服务端所需操作封装，无需用户配置，并提供外网IP和域名，让用户只需配置客户端的部分信息，操作简便，易于使用。</p>
<h2 id="2-2-P2P方式"><a href="#2-2-P2P方式" class="headerlink" title="2.2 P2P方式"></a>2.2 P2P方式</h2><p>代表竞品：Zerotier</p>
<h3 id="2-2-1-Zerotier-开源"><a href="#2-2-1-Zerotier-开源" class="headerlink" title="2.2.1 Zerotier(开源)"></a>2.2.1 Zerotier(开源)</h3><p>Zerotier slogan:securely connect any device anywhere(安全地连接任何地方的任何设备)</p>
<p>理想情况下，在Zerotier中，所有的设备都是客户端，连接方式是点对点。</p>
<h4 id="2-2-1-1-Zerotier与传统内网穿透方案的对比"><a href="#2-2-1-1-Zerotier与传统内网穿透方案的对比" class="headerlink" title="2.2.1.1 Zerotier与传统内网穿透方案的对比"></a>2.2.1.1 Zerotier与传统内网穿透方案的对比</h4><p>传统的内网穿透方案：内网设备&lt;——&gt;中转服务器&lt;———&gt;网络设备（手机、电脑）</p>
<p>弊端：</p>
<p>1.中转服务器需要一定的费用进行支撑，如果是外网的服务器还可能存在被墙的风险。</p>
<p>2.中转服务器直接决定了中转的“速度”，而这个“速度”越快其对应的服务器带宽就越大，通常来说价格也就越高。</p>
<p>3.需要一定的知识储备来搭建内网穿透的服务端，虽然目前由于各种脚本的出现，门槛越来越低，但同时也会出现各种各样的问题，对于某些人来说解决起来较为繁琐。</p>
<p>Zerotier的内网穿透方案：内网设备&lt;——&gt;移动、PC设备（手机、电脑）</p>
<p>理想情况下是端到端的传输，如果网络环境差的话也会借助中转服务器进行传输数据。</p>
<p>优势：</p>
<p>1.操作极其简单，大体可以分为：</p>
<p>创建账号—&gt;创建访问密钥——&gt;需要互通的设备安装zerotier客户端——&gt;输入刚刚创建的访问密钥——&gt;结束</p>
<p>2.正常情况下不依赖服务器进行中转传输文件，端到端连接，理论可以达到满带宽。</p>
<p>3.个人使用可以不需要额外的服务器费用开支，免费版本下可以支持50个设备（不同或者相同网络环境）同时连入软件所创建的虚拟局域网，从而实现局域网内各个设备之间的无限制的访问。</p>
<p>4.Zerotier 支持基本所有设备：Windows、MacOS、iOS、Android、Linux、FreeBSD、Synology、QNAP、WD MyCloud、OpenWRT，支持 Docker。</p>
<h4 id="2-2-1-2-Zerotier组件介绍"><a href="#2-2-1-2-Zerotier组件介绍" class="headerlink" title="2.2.1.2 Zerotier组件介绍"></a>2.2.1.2 Zerotier组件介绍</h4><p><strong>Earth</strong></p>
<p>根据其介绍，将地球上的所有设备连起来。那这里的 Earth 指的就是整体的一个服务。</p>
<p><strong>Network</strong></p>
<p>每一个 Network 包含的所有设备都在同一个网络里。每个网络有一个 Network ID。各客户端通过这个 ID 连接到此网络。当然，一个账号是可以创建多个网络的。</p>
<p>网络基础设置中的 Public 和 Private。一般我们自己组网是要用 Private，需要在页面授权设备才可以进行访问。Public 权限好像不太有人会需要吧..</p>
<p>以下介绍的所有概念都是属于 Network 下的。</p>
<p><strong>Planet</strong></p>
<p>星球，指的是官方提供的服务器节点。各客户端都是通过这些服务来互相寻址的。相当于 zookeeper 的不同节点。目前Zerotier提供的Planet都在国外，国内访问速度较慢。</p>
<p><strong>Moon</strong></p>
<p>自定义的 Planet。由于 Zerotier 没有国内节点，在两个设备刚开始互连的时候有可能需要通过国外的节点寻址，导致创建连接的速度偏慢。在自己的网络里搭建 Moon 可以使连接提速。</p>
<p><strong>Leaf</strong></p>
<p>客户端。就是连接到网络上的每一个设备。其实经过测试，Moon 也是客户端的一种。这里特指没有额外功能，单纯用于连接的客户端。</p>
<h4 id="2-2-1-3-组网原理"><a href="#2-2-1-3-组网原理" class="headerlink" title="2.2.1.3 组网原理"></a>2.2.1.3 组网原理</h4><p>ZeroTier One的原理就是虚拟出一块网卡，连上一个虚拟网络，安装了ZeroTier One客户端的设备可以连入这个网络，经过授权连接成功之后彼此都在同一网段，可以像在局域网一样互相访问，例如访问共享文件夹，web server，ftp server，联机游戏（例如打星际），当然也就包括访问NAS。所以如果你的NAS和你的手机连上了这个网络，不论两台设备具体在哪里，都像同一局域网内，从而实现内网穿透，达到从外网访问内网NAS的目的。</p>
<p><img src="/image/4-9.png" alt="avatar"></p>
<p>主机1可以是群晖主机，主机2可以是手机或平板。只要主机1和主机2都能连到互联网，安装上ZeroTier One的客户端后，就会在本机虚拟出一块网卡，并获得对应IP，图例中是172.28.x.x网段。经过网络所有人授权后（后面会详细讲解），这两个主机就可以通过172.28.x.x网段互相访问了，由于就像在局域网一样，所以基本没有任何限制，任何基于TCP&#x2F;IP的网络服务都可以访问到，自然也就可以访问到群晖了。</p>
<p><em>注：</em>图中省掉了公网IP，因为公网IP多少不重要，只要主机能上公网，能连上ZeroTier，就能获得172网段IP了，也就可以互联互通了。</p>
<h4 id="2-2-1-4-组网流程"><a href="#2-2-1-4-组网流程" class="headerlink" title="2.2.1.4 组网流程"></a>2.2.1.4 组网流程</h4><p>1.注册登录，有Google，Github，Microsoft三种注册登录方式。</p>
<p><img src="/image/4-10.png" alt="avatar"></p>
<p>2.登录后，进入到如下页面，点击Create A Network 创建一个网络。</p>
<p><img src="/image/4-11.png" alt="avatar"></p>
<p>3.表单如下，若无特殊配置，表单信息无需修改，即创建完成</p>
<p><img src="/image/4-12.png" alt="avatar"></p>
<p><img src="/image/4-13.png" alt="avatar"></p>
<p>4.网络创建完成后，接着在需要加入网络的设备安装客户端软件，并打开，加入网络（输入网络的唯一编号，点击加入）即可</p>
<p><img src="/image/4-14.png" alt="avatar"></p>
<p>5.加入网络的设备需要网络管理端审核通过，到网络管理端进行审核通过</p>
<p><img src="/image/4-15.png" alt="avatar"></p>
<p>6.到此，加入该网络的设备即为在同一局域网下，可以实现访问。</p>
<h3 id="2-2-2-总结"><a href="#2-2-2-总结" class="headerlink" title="2.2.2 总结"></a>2.2.2 总结</h3><p>Zerotier通过虚拟化网卡和UDP打洞的方式实现内网穿透，能达到端到端的访问效果，若无法实现该类型的访问效果。Zerotier会使用传统的通过服务器反向代理进行端口映射的内网穿透方式，且由于代理服务器为公用的Plent，速度较慢。可以通过自建Moon服务器解决。</p>
<h3 id="2-2-1-N2N"><a href="#2-2-1-N2N" class="headerlink" title="2.2.1 N2N"></a>2.2.1 N2N</h3><p>在一般情况下， 两台机器如果是处在同一个局域网下，那么这两台机器可以通过各自的内网IP进行通信。 但是，在某些情况下你可能希望两个不同局域网的机器进行通信 ， 此时 N2N 就能给我们带来一个简单快捷的解决方案，N2N 通过一些特殊的技巧，让不同网段的机器能够进行P2P( 点对点 peer-to-peer ) 通信。</p>
<h4 id="2-2-1-1-N2N原理"><a href="#2-2-1-1-N2N原理" class="headerlink" title="2.2.1.1 N2N原理"></a>2.2.1.1 N2N原理</h4><p>在一般情况下，两台没有公网IP的机器是没有办法直接通过IP地址去找到对方的，这时候如果有一台拥有公网IP的服务器的话，那么事情就会变得很简单。<br>首先，两台处于内部网络的机器主动去跟拥有公网IP的机器进行连接，然后向处于公网的服务器进行“注册登记”， 留下自己的连接方式 ，告诉公网服务器，如果有其它机器要找我，就把这些信息给它，它就知道怎么能够找到我了。 当然，出于安全考虑，这些想要相互连接的机器会留下一些验证口令， 只有口令正确匹配，它们才能够正确的组网。<br>以上的描述只是帮助你去理解N2N做的事情，但在实际的实现中，边缘节点的连接会有更复杂的策略，而且项目仍然在不断的更新中，如需要继续深入研究，可以查看N2N的源码(<a target="_blank" rel="noopener" href="https://github.com/ntop/n2n">https://github.com/ntop/n2n</a>)</p>
<h4 id="2-2-1-2-N2N-概念"><a href="#2-2-1-2-N2N-概念" class="headerlink" title="2.2.1.2 N2N 概念"></a>2.2.1.2 N2N 概念</h4><p>在上面描述的流程中， N2N 官方对里面的角色有一些定义，了解这些定义，能够帮助你快速理解这个软件的使用。<br>SuperNode 超级节点<br>SuperNode 相当与注册中心, 它会记录边缘节点的连接信息，告诉各个边缘节点如何去找到其它的边缘节点。如果超级节点发生故障，那么边缘节点之间将不能正常的进行通信。在整个N2N网络中必须至少拥有一个SuperNode。<br>Edge 边缘节点<br>边缘节点是指所有通过 SuperNode 组网而成的节点，无论你处于哪个位置哪种网络环境下，edge节点之间都能进行通信。<br>一台计算机可以拥有多个edge, 局域网根据子网掩码来决定两台机器是否处于同一个网段，而edge需要添加一组账号密码，在N2N 里面称作 GroupName 和 password ，Group0 和 Group 1 里面的 10.0.0.1 是不一样的。</p>
<h2 id="3、打洞概念"><a href="#3、打洞概念" class="headerlink" title="3、打洞概念"></a>3、打洞概念</h2><p>在内网穿透传输大量数据时如果都经过服务器中转的话，这样会对服务器端带宽压力比较大。只要是数据量很大，而一般利用中转服务器又需要一定规模投入的应用，我们都可以考虑用P2P技术。</p>
<h3 id="3-1-NAT-类别"><a href="#3-1-NAT-类别" class="headerlink" title="3.1 NAT 类别"></a>3.1 NAT 类别</h3><p><strong>Full Cone NAT（全锥形NAT）</strong> 其特点为：一旦内部主机端口对(iAddr:iPort)被NAT网关映射到(eAddr:ePort)，所有后续的(iAddr:iPort)报文都会被转换为(eAddr:ePort)；任何一个外部主机发送到(eAddr:ePort)的报文将会被转换后发到(iAddr:iPort)。 <strong>Restricted Cone NAT（限制锥形NAT）</strong> 其特点为：一旦内部主机端口对(iAddr:iPort)被映射到(eAddr:ePort)，所有后续的(iAddr:iPort)报文都会被转换为(eAddr:ePort)；只有 (iAddr:iPort)向特定的外部主机hAddr发送过数据，主机hAddr从任意端口发送到(eAddr:ePort)的报文将会被转发到(iAddr:iPort)。 <strong>Port Restricted Cone NAT（端口限制锥形NAT）</strong> 其特点为：一旦内部主机端口对(iAddr:iPort)被映射到(eAddr:ePort)，所有后续的(iAddr:iPort)报文都会被转换为(eAddr:ePort)；只有(iAddr:iPort)向特定的外部主机端口对(hAddr:hPort)发送过数据，由 (hAddr:hPort)发送到(eAddr:ePort)的报文将会被转发到(iAddr:iPort)。 <strong>Symmetric NAT（对称型NAT）</strong> 其特点为：NAT网关会把内部主机“地址端口对”和外部主机“地址端口对”完全相同的报文看作一个连接，在网关上创建一个公网“地址端口对”映射进行转换，只有收到报文的外部主机从对应的端口对发送回应的报文，才能被转换。即使内部主机使用之前用过的地址端口对去连接不同外部主机(或端口)时，NAT网关也会建立新的映射关系。<br>事实上，这些术语的引入是很多混淆的起源。现实中的很多NAT设备是将这些转换方式混合在一起工作的，而不单单使用一种，所以这些术语只适合描述一种工作方式，而不是一个设备。比如，很多NAT设备对内部发出的连接使用对称型NAT方式，而同时支持静态的端口映射，后者可以被看作是全锥型NAT方式。而有些情况下，NAT设备的一个公网地址和端口可以同时映射到内部几个服务器上以实现负载分担，比如一个对外提供WEB服务器的站点可能是有成百上千个服务器在提供HTTP服务，但是对外却表现为一个或少数几个IP地址。</p>
<h3 id="3-2-P2P实现内网穿透"><a href="#3-2-P2P实现内网穿透" class="headerlink" title="3.2 P2P实现内网穿透"></a>3.2 P2P实现内网穿透</h3><p>根据客户端的不同，客户端之间进行P2P传输的方法也略有不同，这里介绍了现有的穿越中间件进行P2P通信的几种技术。</p>
<h4 id="3-2-1-中继（Relaying）"><a href="#3-2-1-中继（Relaying）" class="headerlink" title="3.2.1 中继（Relaying）"></a>3.2.1 中继（Relaying）</h4><p>这是最可靠但也是最低效的一种P2P通信实现。其原理是通过一个有公网IP的服务器中间人对两个内网客户端的通信数据进行中继和转发。如下图所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Server S                          |                          |   +----------------------+----------------------+   |                                             | NAT A                                         NAT B   |                                             |   |                                             |Client A                                      Client B</span><br></pre></td></tr></table></figure>

<p>客户端A和客户端B不直接通信，而是先都与服务端S建立链接，然后再通过S和对方建立的通路来中继传递的数据。</p>
<p>这种方法的缺陷很明显， 当链接的客户端变多之后，会显著增加服务器的负担，完全没体现出P2P的优势。但这种方法的好处是能保证成功，因此在实践中也常作为一种备选方案。</p>
<h4 id="3-2-2-逆向链接（Connection-reversal）"><a href="#3-2-2-逆向链接（Connection-reversal）" class="headerlink" title="3.2.2 逆向链接（Connection reversal）"></a>3.2.2 逆向链接（Connection reversal）</h4><p>第二种方法在当两个端点中有一个不存在中间件的时候有效。例如，客户端A在NAT之后而客户端B拥有全局IP地址，如下图：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Server S                        18.181.0.31:1235                               |                               |        +----------------------+----------------------+        |                                             |      NAT A                                           |155.99.25.11:62000                                    |        |                                             |        |                                             |     Client A                                      Client B  10.0.0.1:1234                               138.76.29.7:1234　</span><br></pre></td></tr></table></figure>

<p>客户端A内网地址为10.0.0.1，且应用程序正在使用TCP端口1234。<strong>A和服务器S建立了一个链接，服务器的IP地址为18.181.0.31，监听1235端口。NAT A给客户端A分配了TCP端口62000，地址为NAT的公网IP地址155.99.25.11， 作为客户端A对外当前会话的临时IP和端口</strong>。因此S认为客户端A就是155.99.25.11:62000。而B由于有公网地址，所以对S来说B就是138.76.29.7:1234。</p>
<p>当客户端B想要发起一个对客户端A的P2P链接时，要么链接A的外网地址155.99.25.11:62000，要么链接A的内网地址10.0.0.1:1234，然而两种方式链接都会失败。 链接10.0.0.1:1234失败自不用说，<strong>为什么链接155.99.25.11:62000也会失败呢？来自B的TCP SYN握手请求到达NAT A的时候会被拒绝，因为对NAT A来说只有外出的链接才是允许的</strong>。 在直接链接A失败之后，B可以通过S向A中继一个链接请求，从而从A方向“逆向“地建立起A-B之间的点对点链接。</p>
<p>很多当前的P2P系统都实现了这种技术，但其局限性也是很明显的，只有当其中一方有公网IP时链接才能建立。越来越多的情况下， 通信的双方都在NAT之后，因此就要用到我们下面介绍的第三种技术了。</p>
<h4 id="3-2-3-UDP打洞（UDP-hole-punching）"><a href="#3-2-3-UDP打洞（UDP-hole-punching）" class="headerlink" title="3.2.3 UDP打洞（UDP hole punching）"></a>3.2.3 UDP打洞（UDP hole punching）</h4><p>UDP打洞技术有一个主要的条件：只有当两个NAT都是Cone NAT（或者非NAT的防火墙）时才能工作。因为其维持了一个给定的（内网IP，内网UDP）二元组 和（公网IP， 公网UDP）二元组固定的端口绑定，只要该UDP端口还在使用中，就不会变化。如果像对称NAT一样，给每个新会话分配一个新的公网端口，就 会导致UDP应用程序无法使用跟外部端点已经打通了的通信链路。由于Cone NAT是当今最广泛使用的，尽管有一小部分的对称NAT是不支持打洞的，UDP打洞 技术也还是被广泛采纳应用。</p>
<p><strong>端点在不同的NAT之后</strong></p>
<p>假设客户端A和客户端B的地址都是内网地址，且在不同的NAT后面。A、B上运行的P2P应用程序和服务器S都使用了UDP端口1234，A和B分别初始化了 与Server的UDP通信，地址映射如图所示:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Server S                        18.181.0.31:1234                               |                               |        +----------------------+----------------------+        |                                             |      NAT A                                         NAT B155.99.25.11:62000                            138.76.29.7:31000        |                                             |        |                                             |     Client A                                      Client B  10.0.0.1:1234                                 10.1.1.3:1234</span><br></pre></td></tr></table></figure>

<p>现在假设客户端A打算与客户端B直接建立一个UDP通信会话。如果A直接给B的公网地址138.76.29.7:31000发送UDP数据，NAT B将很可能会无视进入的 数据（除非是Full Cone NAT），因为源地址和端口与S不匹配，而最初只与S建立过会话。B往A直接发信息也类似。</p>
<p>假设A开始给B的公网地址发送UDP数据的同时，给服务器S发送一个中继请求，要求B开始给A的公网地址发送UDP信息。A往B的输出信息会导致NAT A打开 一个A的内网地址与与B的外网地址之间的新通讯会话，B往A亦然。一旦新的UDP会话在两个方向都打开之后，客户端A和客户端B就能直接通讯， 而无须再通过引导服务器S了。</p>
<p>UDP打洞技术有许多有用的性质。一旦一个的P2P链接建立，链接的双方都能反过来作为“引导服务器”来帮助其他中间件后的客户端进行打洞， 极大减少了服务器的负载。应用程序不需要知道中间件具体是什么（如果有的话），因为以上的过程在没有中间件或者有多个中间件的情况下 也一样能建立通信链路。</p>
<h5 id="2-2-3-1-思路"><a href="#2-2-3-1-思路" class="headerlink" title="2.2.3.1 思路"></a>2.2.3.1 思路</h5><p>这里的大体思路是，输入命令传输给服务器之后，接收来自服务器的反馈，并执行相应代码。例如A想要与B建立 通信链路，先给服务器发送punch命令以及给B发送数据，服务器接到命令后给B发送punch_requst信息以及A的端点信息，B收到之后向A发送数据打通通路，然 后A与B就可以进行P2P通信了。经测试，打通通路后即便把服务器关闭，A与B也能正常通信。</p>
<p>3.2.4 TCP 打洞</p>
<p>关于TCP打洞，有一点需要提的是，因为TCP是基于连接的，所以任何未经连接而发送的数据都会被丢弃，这导致在recv的时候是无法直接从peer端读取数据。 其实这对UDP也一样，如果对UDP的socket进行了connect，其也会忽略连接之外的数据，详见connect(2)。</p>
<p>所以，如果我们要进行TCP打洞，通常需要重用本地的endpoint来发起新的TCP连接，这样才能将已经打开的NAT利用起来。具体来说，则是要设置socket的 SO_REUSEADDR或SO_REUSEPORT属性，根据系统不同，其实现也不尽一致。一般来说，TCP打洞的步骤如下：</p>
<ul>
<li><p>A 发送 SYN 到 B （出口地址，下同），从而创建NAT A的一组映射</p>
</li>
<li><p>B 发送 SYN 到 A， 创建NAT B的一组映射</p>
</li>
<li><p>根据时序不同，两个SYN中有一个会被对方的NAT丢弃，另一个成功通过NAT</p>
</li>
<li><p>通过NAT的SYN报文被其中一方收到，即返回SYNACK， 完成握手</p>
</li>
<li><p>至此，TCP的打洞成功，获得一个不依赖于服务器的链接</p>
</li>
</ul>
<h2 id="4、总结"><a href="#4、总结" class="headerlink" title="4、总结"></a>4、总结</h2><p>内网穿透传统方式会出现服务器和客户机之间的数据传输全部经过中转服务器，传输速度将受制于中转服务器的上下行带宽，不过稳定性很好，对于自己要购置的云主机要求就是大带宽，一般这种云主机按流量计费，传输的数据量越大价格自然越贵。</p>
<p>所以点对点穿透便能解决流量带来的困扰，点对点可以实现服务器和客户机之间打洞直接进行数据通信，这种方式一般用于udp协议的传输，比如应用于远程NAS看视频听歌，但这种方式需要服务器和客户机都安装穿透工具，对用户访问端来说不够方便，并且这种方式受复杂网络环境影响较大。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://example.com">渊鱼</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2023/03/18/%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F%E6%A6%82%E5%BF%B5%E5%8F%8A%E5%AE%9E%E7%8E%B0%E5%92%8C%E7%AB%9E%E5%93%81%E5%88%86%E6%9E%90/">http://example.com/2023/03/18/%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F%E6%A6%82%E5%BF%B5%E5%8F%8A%E5%AE%9E%E7%8E%B0%E5%92%8C%E7%AB%9E%E5%93%81%E5%88%86%E6%9E%90/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">Poem blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E7%BD%91%E7%BB%9C/">网络</a><a class="post-meta__tags" href="/tags/%E6%8A%80%E6%9C%AF/">技术</a><a class="post-meta__tags" href="/tags/%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F/">内网穿透</a></div><div class="post_share"><div class="social-share" data-image="/image/3.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/03/18/%E5%9B%BE%E8%A7%A3%E5%AF%86%E7%A0%81%E6%8A%80%E6%9C%AF%E6%A2%B3%E7%90%86%E5%92%8C%E5%BD%92%E7%BA%B3%E6%80%BB%E7%BB%93--3/" title="《图解密码技术》梳理和归纳总结--3"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">《图解密码技术》梳理和归纳总结--3</div></div></a></div><div class="next-post pull-right"><a href="/2023/03/17/%E5%9B%BE%E8%A7%A3%E5%AF%86%E7%A0%81%E6%8A%80%E6%9C%AF%E6%A2%B3%E7%90%86%E5%92%8C%E5%BD%92%E7%BA%B3%E6%80%BB%E7%BB%93--2/" title="《图解密码技术》梳理和归纳总结--2"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">《图解密码技术》梳理和归纳总结--2</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2023/03/09/%E5%9B%BE%E8%A7%A3%E5%AF%86%E7%A0%81%E6%8A%80%E6%9C%AF%E6%A2%B3%E7%90%86%E5%92%8C%E5%BD%92%E7%BA%B3%E6%80%BB%E7%BB%93--1/" title="《图解密码技术》梳理和归纳总结--1"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-03-09</div><div class="title">《图解密码技术》梳理和归纳总结--1</div></div></a></div><div><a href="/2023/03/17/%E5%9B%BE%E8%A7%A3%E5%AF%86%E7%A0%81%E6%8A%80%E6%9C%AF%E6%A2%B3%E7%90%86%E5%92%8C%E5%BD%92%E7%BA%B3%E6%80%BB%E7%BB%93--2/" title="《图解密码技术》梳理和归纳总结--2"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-03-17</div><div class="title">《图解密码技术》梳理和归纳总结--2</div></div></a></div><div><a href="/2023/03/18/%E5%9B%BE%E8%A7%A3%E5%AF%86%E7%A0%81%E6%8A%80%E6%9C%AF%E6%A2%B3%E7%90%86%E5%92%8C%E5%BD%92%E7%BA%B3%E6%80%BB%E7%BB%93--3/" title="《图解密码技术》梳理和归纳总结--3"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-03-18</div><div class="title">《图解密码技术》梳理和归纳总结--3</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/image/3.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">渊鱼</div><div class="author-info__description">记录一些看过的书&产品成长学习轨迹</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">4</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">5</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/poemweb/poemweb.github.io" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:545557953@qq.com" target="_blank" title="545557953@qq.com"><i class="fas fa-envelope"></i></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1%E3%80%81%E4%BB%80%E4%B9%88%E6%98%AF%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F"><span class="toc-number">1.</span> <span class="toc-text">1、什么是内网穿透</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-%E5%86%85%E7%BD%91-x2F-%E5%A4%96%E7%BD%91%E5%AE%9A%E4%B9%89"><span class="toc-number">1.1.</span> <span class="toc-text">1.1 内网&#x2F;外网定义</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F%E6%A6%82%E8%BF%B0"><span class="toc-number">1.2.</span> <span class="toc-text">1.2 内网穿透概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-NAT%E7%9A%84%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F"><span class="toc-number">1.3.</span> <span class="toc-text">1.3 NAT的实现方式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-4-NAT%E7%A9%BF%E9%80%8F%E5%8E%9F%E7%90%86"><span class="toc-number">1.4.</span> <span class="toc-text">1.4 NAT穿透原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-5-%E8%AE%BF%E9%97%AE%E5%86%85%E7%BD%91%E7%9A%84%E6%96%B9%E6%B3%95"><span class="toc-number">1.5.</span> <span class="toc-text">1.5 访问内网的方法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5-1-ddns%E5%8A%A8%E6%80%81%E5%9F%9F%E5%90%8D%E7%BB%91%E5%AE%9A-%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91%EF%BC%88%E8%83%BD%E8%AE%BF%E9%97%AE%E5%86%85%E7%BD%91%EF%BC%8C%E4%B8%8D%E7%AE%97%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F%EF%BC%89"><span class="toc-number">1.5.1.</span> <span class="toc-text">1.5.1 ddns动态域名绑定+端口转发（能访问内网，不算内网穿透）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5-2-%E7%AB%AF%E5%8F%A3%E6%98%A0%E5%B0%84"><span class="toc-number">1.5.2.</span> <span class="toc-text">1.5.2 端口映射</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5-3-%E5%BC%82%E5%9C%B0%E7%BB%84%E7%BD%91"><span class="toc-number">1.5.3.</span> <span class="toc-text">1.5.3 异地组网</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5-4-%E6%80%BB%E7%BB%93"><span class="toc-number">1.5.4.</span> <span class="toc-text">1.5.4 总结</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2%E3%80%81%E7%AB%9E%E5%93%81%E5%88%86%E6%9E%90"><span class="toc-number">2.</span> <span class="toc-text">2、竞品分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-%E7%AB%AF%E5%8F%A3%E6%98%A0%E5%B0%84"><span class="toc-number">2.1.</span> <span class="toc-text">2.1 端口映射</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-1-Frp%EF%BC%88%E5%BC%80%E6%BA%90%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%EF%BC%89"><span class="toc-number">2.1.1.</span> <span class="toc-text">2.1.1 Frp（开源解决方案）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-1-1-%E6%A6%82%E8%BF%B0"><span class="toc-number">2.1.1.1.</span> <span class="toc-text">2.1.1.1 概述</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-1-2-Frp%E7%89%B9%E7%82%B9%E4%B8%8E%E5%8E%9F%E7%90%86"><span class="toc-number">2.1.1.2.</span> <span class="toc-text">2.1.1.2 Frp特点与原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-1-3-Frp%E7%9A%84%E4%BD%BF%E7%94%A8%E6%B5%81%E7%A8%8B"><span class="toc-number">2.1.1.3.</span> <span class="toc-text">2.1.1.3 Frp的使用流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-1-4-%E6%80%BB%E7%BB%93"><span class="toc-number">2.1.1.4.</span> <span class="toc-text">2.1.1.4 总结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-2-%E8%8A%B1%E7%94%9F%E5%A3%B3"><span class="toc-number">2.1.2.</span> <span class="toc-text">2.1.2 花生壳</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-2-1-%E6%A6%82%E8%BF%B0"><span class="toc-number">2.1.2.1.</span> <span class="toc-text">2.1.2.1 概述</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-2-2-%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F%E6%93%8D%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="toc-number">2.1.2.2.</span> <span class="toc-text">2.1.2.2 内网穿透操作流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-2-3-%E6%80%BB%E7%BB%93"><span class="toc-number">2.1.2.3.</span> <span class="toc-text">2.1.2.3 总结</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-P2P%E6%96%B9%E5%BC%8F"><span class="toc-number">2.2.</span> <span class="toc-text">2.2 P2P方式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-1-Zerotier-%E5%BC%80%E6%BA%90"><span class="toc-number">2.2.1.</span> <span class="toc-text">2.2.1 Zerotier(开源)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-1-1-Zerotier%E4%B8%8E%E4%BC%A0%E7%BB%9F%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F%E6%96%B9%E6%A1%88%E7%9A%84%E5%AF%B9%E6%AF%94"><span class="toc-number">2.2.1.1.</span> <span class="toc-text">2.2.1.1 Zerotier与传统内网穿透方案的对比</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-1-2-Zerotier%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D"><span class="toc-number">2.2.1.2.</span> <span class="toc-text">2.2.1.2 Zerotier组件介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-1-3-%E7%BB%84%E7%BD%91%E5%8E%9F%E7%90%86"><span class="toc-number">2.2.1.3.</span> <span class="toc-text">2.2.1.3 组网原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-1-4-%E7%BB%84%E7%BD%91%E6%B5%81%E7%A8%8B"><span class="toc-number">2.2.1.4.</span> <span class="toc-text">2.2.1.4 组网流程</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-2-%E6%80%BB%E7%BB%93"><span class="toc-number">2.2.2.</span> <span class="toc-text">2.2.2 总结</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-1-N2N"><span class="toc-number">2.2.3.</span> <span class="toc-text">2.2.1 N2N</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-1-1-N2N%E5%8E%9F%E7%90%86"><span class="toc-number">2.2.3.1.</span> <span class="toc-text">2.2.1.1 N2N原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-1-2-N2N-%E6%A6%82%E5%BF%B5"><span class="toc-number">2.2.3.2.</span> <span class="toc-text">2.2.1.2 N2N 概念</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81%E6%89%93%E6%B4%9E%E6%A6%82%E5%BF%B5"><span class="toc-number">2.3.</span> <span class="toc-text">3、打洞概念</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-NAT-%E7%B1%BB%E5%88%AB"><span class="toc-number">2.3.1.</span> <span class="toc-text">3.1 NAT 类别</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-P2P%E5%AE%9E%E7%8E%B0%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F"><span class="toc-number">2.3.2.</span> <span class="toc-text">3.2 P2P实现内网穿透</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-1-%E4%B8%AD%E7%BB%A7%EF%BC%88Relaying%EF%BC%89"><span class="toc-number">2.3.2.1.</span> <span class="toc-text">3.2.1 中继（Relaying）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-2-%E9%80%86%E5%90%91%E9%93%BE%E6%8E%A5%EF%BC%88Connection-reversal%EF%BC%89"><span class="toc-number">2.3.2.2.</span> <span class="toc-text">3.2.2 逆向链接（Connection reversal）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-3-UDP%E6%89%93%E6%B4%9E%EF%BC%88UDP-hole-punching%EF%BC%89"><span class="toc-number">2.3.2.3.</span> <span class="toc-text">3.2.3 UDP打洞（UDP hole punching）</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-3-1-%E6%80%9D%E8%B7%AF"><span class="toc-number">2.3.2.3.1.</span> <span class="toc-text">2.2.3.1 思路</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E3%80%81%E6%80%BB%E7%BB%93"><span class="toc-number">2.4.</span> <span class="toc-text">4、总结</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/03/18/%E5%9B%BE%E8%A7%A3%E5%AF%86%E7%A0%81%E6%8A%80%E6%9C%AF%E6%A2%B3%E7%90%86%E5%92%8C%E5%BD%92%E7%BA%B3%E6%80%BB%E7%BB%93--3/" title="《图解密码技术》梳理和归纳总结--3">《图解密码技术》梳理和归纳总结--3</a><time datetime="2023-03-18T07:41:03.559Z" title="发表于 2023-03-18 15:41:03">2023-03-18</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/03/18/%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F%E6%A6%82%E5%BF%B5%E5%8F%8A%E5%AE%9E%E7%8E%B0%E5%92%8C%E7%AB%9E%E5%93%81%E5%88%86%E6%9E%90/" title="内网穿透原理和竞品分析">内网穿透原理和竞品分析</a><time datetime="2023-03-18T07:31:50.033Z" title="发表于 2023-03-18 15:31:50">2023-03-18</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/03/17/%E5%9B%BE%E8%A7%A3%E5%AF%86%E7%A0%81%E6%8A%80%E6%9C%AF%E6%A2%B3%E7%90%86%E5%92%8C%E5%BD%92%E7%BA%B3%E6%80%BB%E7%BB%93--2/" title="《图解密码技术》梳理和归纳总结--2">《图解密码技术》梳理和归纳总结--2</a><time datetime="2023-03-17T03:28:18.580Z" title="发表于 2023-03-17 11:28:18">2023-03-17</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/03/09/%E5%9B%BE%E8%A7%A3%E5%AF%86%E7%A0%81%E6%8A%80%E6%9C%AF%E6%A2%B3%E7%90%86%E5%92%8C%E5%BD%92%E7%BA%B3%E6%80%BB%E7%BB%93--1/" title="《图解密码技术》梳理和归纳总结--1">《图解密码技术》梳理和归纳总结--1</a><time datetime="2023-03-09T09:20:10.334Z" title="发表于 2023-03-09 17:20:10">2023-03-09</time></div></div></div></div></div></div></main><footer id="footer" style="background: url(/css/back.css)"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By 渊鱼</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>